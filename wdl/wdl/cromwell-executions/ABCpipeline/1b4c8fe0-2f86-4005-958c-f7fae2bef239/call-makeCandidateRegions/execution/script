#!/bin/bash

cd /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution
tmpDir=$(mkdir -p "/cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/tmp.b50bbb75" && echo "/cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/tmp.b50bbb75")
chmod 777 "$tmpDir"
export _JAVA_OPTIONS=-Djava.io.tmpdir="$tmpDir"
export TMPDIR="$tmpDir"
export HOME="$HOME"
(
cd /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution

)
out1b4c8fe0="${tmpDir}/out.$$" err1b4c8fe0="${tmpDir}/err.$$"
mkfifo "$out1b4c8fe0" "$err1b4c8fe0"
trap 'rm "$out1b4c8fe0" "$err1b4c8fe0"' EXIT
tee '/cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution/stdout' < "$out1b4c8fe0" &
tee '/cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution/stderr' < "$err1b4c8fe0" >&2 &
(
cd /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution


set -euo pipeline

mkdir outputs

python src/makeCandidateRegions.py \
    --bam /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/inputs/344356579/wgEncodeUwDnaseK562AlnRep1.chr22.bam \
    --outDir outputs \
    --chrom_sizes /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/inputs/-378025230/chr22 \
    --regions_blacklist /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/inputs/-378025230/wgEncodeHg19ConsensusSignalArtifactRegions.bed \
    --regions_whitelist /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/inputs/-378025230/RefSeqCurated.170308.bed.CollapsedGeneBounds.TSS.500bp.chr22.bed \
    --pval_cutoff 0.1 \
    --peakExtendFromSummit 250 \
    --nStrongestPeaks 3000
)  > "$out1b4c8fe0" 2> "$err1b4c8fe0"
echo $? > /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution/rc.tmp
(
# add a .file in every empty directory to facilitate directory delocalization on the cloud
cd /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution
find . -type d -exec sh -c '[ -z "$(ls -A '"'"'{}'"'"')" ] && touch '"'"'{}'"'"'/.file' \;
)
(
cd /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution
sync


)
mv /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution/rc.tmp /cromwell-executions/ABCpipeline/1b4c8fe0-2f86-4005-958c-f7fae2bef239/call-makeCandidateRegions/execution/rc

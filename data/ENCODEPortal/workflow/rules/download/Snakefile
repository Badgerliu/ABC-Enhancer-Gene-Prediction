import yaml
ASSAYS=["DHS", "H3K27ac", "ATAC"]
endtype = ["pairedend", "singleend"]

# config files 
config = yaml.load(open('../../envs/wd.yaml'))


OUTPUT_FILES=[]

# Add output files from downloading metadata 
#OUTPUT_FILES.extend(expand("{config}/bam_{genome_build}_{assay}.tsv", config=config['params_preprocess']['preprocess_dir'], assay=ASSAYS, genome_build=config['params_download']['genome']))
OUTPUT_FILES.extend(expand("{config}/unique_{endtype}_h3k27ac_dhs_files.tsv", config=config['params_preprocess']['preprocess_dir'], endtype=endtype))

# Add output files from download paired-end, single-end metadata 

rule target:
	input: OUTPUT_FILES

rule download_bam:
        input:
                exe = config['prefix']['workflow_scripts']+"download_log.sh",
		outdir = config['params_preprocess']['preprocess_dir']

        message: "Executing log bash files to download files"
        
	params:	genome_build = config['params_download']['genome']

	output:	files = expand("{config}/bam_{genome_build}_{assay}.tsv", config=config['params_preprocess']['preprocess_dir'], assay=ASSAYS, genome_build=config['params_download']['genome'])		
	
	shell: """
		bash {input.exe}
		mv *hg19* {input.outdir}
		mv *38* {input.outdir}
		""" 


# filter files 
rule filter_files:
        input:
                exe = config['prefix']['workflow_scripts']+"grabDownload.py",
                dir = config['params_preprocess']['preprocess_dir'],
		data = expand("{config}/bam_{genome_build}_{assays}.tsv", config=config['params_preprocess']['preprocess_dir'], assays=ASSAYS, genome_build=config['params_download']['genome'])

	output: expand("{config}/unique_{endtype}_h3k27ac_dhs_files.tsv", config=config['params_preprocess']['preprocess_dir'], endtype=endtype)

        shell: """
		python {input.exe} --dhs {input.data[0]} --h3k27ac {input.data[1]} --atac {input.data[2]} --genome_assembly hg19 --include_extra_map_length --download_files --outdir {input.dir}
		cat {input.dir}/Experiments_ToCombine.txt.tmp | sed 's/[][]//g' | sed s/"'"//g | sed "s/,/   /g" > {input.dir}/Experiments_ToCombine.txt
		"""

